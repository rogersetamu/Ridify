<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ridify</title>
  <style>
    :root {
      --bg: #ffffff;
      --primary: #4d79a3;
      --primary-dark: #29405a;
      --text: #111111;
      --subtle: #e3ecf4;
      --border: #b3c4d4;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background-color: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color: var(--text);
    }

    .app-frame {
      position: relative;
      width: 100%;
      min-height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      padding: 40px 24px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: var(--bg);
    }

    /* removed .app-notch visual bar */

    .app-main {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      text-align: center;
    }

    .logo {
      font-size: 32px;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      font-weight: 700;
      margin: 0;
    }

    .subtitle {
      margin: 0;
      font-size: 14px;
      color: #666666;
      padding: 0 10px;
    }

    .primary-btn {
      min-width: 60%;
      max-width: 260px;
      padding: 16px 24px;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      box-shadow: 0 6px 0 var(--primary-dark);
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.08s ease;
    }

    .primary-btn:active {
      transform: translateY(3px);
      box-shadow: 0 3px 0 var(--primary-dark);
      background: #426b92;
    }

    /* Location step */
    .location-step {
      width: 100%;
      display: none; /* shown after START */
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .icon-btn {
      width: 74px;
      height: 74px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.08s ease, border-color 0.08s ease;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.12);
    }

    .icon-btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 rgba(0, 0, 0, 0.12);
    }

    .status-bad {
      background: #f7d9d9;
      border-color: #e29a9a;
      color: #a33;
    }

    .status-good {
      background: #d4edda;
      border-color: #8fd19e;
      color: #155724;
    }

    /* QR step */
    .qr-area {
      width: 100%;
      display: none;          /* shown after location ok */
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
      padding-bottom: 8px;
    }

    #qr-container {
      min-height: 0;
    }

    #result {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    #link-field {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 13px;
      outline: none;
    }

    #copy-btn {
      margin-top: 4px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: var(--subtle);
      color: var(--primary-dark);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    #cancel-btn {
      display: none;          /* only visible in location/QR states */
      margin-top: 12px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: #f7d9d9;
      color: #a33;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    @media (max-height: 640px) {
      .app-main {
        justify-content: flex-start;
        margin-top: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="app-frame">
    <!-- removed app-notch -->

    <div class="app-main">
      <h1 class="logo">RIDIFY</h1>

      <!-- Home state -->
      <button id="create-btn" class="primary-btn">START</button>

      <!-- Location permission step -->
      <div id="location-step" class="location-step">
        <p id="location-text" class="subtitle">
          Tap the icon to allow location so we can generate your ride code.
        </p>
        <button id="location-btn" class="icon-btn status-bad" aria-label="Allow location">
          üìç
        </button>
      </div>

      <!-- QR code step -->
      <div class="qr-area" id="qr-area">
        <div id="qr-container"></div>
        <div id="result"></div>
      </div>

      <!-- Cancel (used in both non-home states) -->
      <button id="cancel-btn">Cancel</button>
    </div>
  </div>

  <!-- QRCode library for client-side QR generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    function generateToken() {
      if (crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
        (c ^ (crypto.getRandomValues(new Uint8Array(1))[0] & 15) >> (c / 4)).toString(16)
      );
    }

    const createBtn = document.getElementById("create-btn");
    const locationStep = document.getElementById("location-step");
    const locationBtn = document.getElementById("location-btn");
    const locationText = document.getElementById("location-text");
    const qrArea = document.getElementById("qr-area");
    const qrContainer = document.getElementById("qr-container");
    const resultDiv = document.getElementById("result");
    const cancelBtn = document.getElementById("cancel-btn");

    let locationRequestCanceled = false;

    function setIconStatus(el, ok) {
      el.classList.toggle("status-good", ok);
      el.classList.toggle("status-bad", !ok);
    }

    function showHome() {
      // reset state
      locationRequestCanceled = true;

      createBtn.style.display = "inline-block";
      locationStep.style.display = "none";
      qrArea.style.display = "none";
      cancelBtn.style.display = "none";

      setIconStatus(locationBtn, false);
      locationText.textContent =
        "Tap the icon to allow location so we can generate your ride code.";

      qrContainer.innerHTML = "";
      resultDiv.innerHTML = "";
    }

    function showLocationStep() {
      createBtn.style.display = "none";
      locationStep.style.display = "flex";
      qrArea.style.display = "none";
      cancelBtn.style.display = "inline-block";
      locationRequestCanceled = false;
    }

    function showQrStep() {
      locationStep.style.display = "none";
      qrArea.style.display = "flex";
      cancelBtn.style.display = "inline-block";
    }

    // START button: go to location step
    createBtn.addEventListener("click", () => {
      showLocationStep();
    });

    // Location button: request geolocation (for demo only) and then generate QR
    locationBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      locationText.textContent = "Requesting location permission‚Ä¶";
      locationRequestCanceled = false;

      navigator.geolocation.getCurrentPosition(
        () => {
          if (locationRequestCanceled) return;

          // We intentionally ignore the actual coordinates.
          setIconStatus(locationBtn, true);
          locationText.textContent = "Location allowed. Generating ride code‚Ä¶";

          generateQrAndShow();
        },
        error => {
          if (locationRequestCanceled) return;

          setIconStatus(locationBtn, false);
          locationText.textContent = "Location access denied: " + error.message;
        }
      );
    });

    function generateQrAndShow() {
      const token = generateToken();
      const base = window.location.href.replace(/[^\/]*$/, "");
      const link = `${base}scan.html?token=${encodeURIComponent(token)}`;

      qrContainer.innerHTML = "";
      new QRCode(qrContainer, {
        text: link,
        width: 200,
        height: 200
      });

      resultDiv.innerHTML = "";
      const p = document.createElement("p");
      p.textContent = "Share this link with your rider:";

      const input = document.createElement("input");
      input.id = "link-field";
      input.readOnly = true;
      input.value = link;

      const copyButton = document.createElement("button");
      copyButton.id = "copy-btn";
      copyButton.textContent = "Copy link";
      copyButton.addEventListener("click", () => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(link).then(() => {
            alert("Link copied to clipboard");
          });
        } else {
          input.select();
          document.execCommand("copy");
          alert("Link copied to clipboard");
        }
      });

      resultDiv.appendChild(p);
      resultDiv.appendChild(input);
      resultDiv.appendChild(copyButton);

      showQrStep();
    }

    // Cancel from either location step or QR step
    cancelBtn.addEventListener("click", () => {
      showHome();
    });

    // initial state
    showHome();
  </script>
</body>
</html>

